#!/usr/bin/env bash
set -e

# ----------------------------------------------------------
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∞–≤–∫–∏ main.py: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–∫ —Ñ–∞–π–ª
# ----------------------------------------------------------
FILE="main.py"

if [[ ! -f "$FILE" ]]; then
  echo "‚ö†Ô∏è –û—à–∏–±–∫–∞: $FILE –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏."
  exit 1
fi

# 1) –î–æ–±–∞–≤–ª—è–µ–º import os, –µ—Å–ª–∏ –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
if ! grep -q "^import os" "$FILE"; then
  sed -i "2iimport os" "$FILE"
  echo "–î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç os"
fi

# 2) –ó–∞–º–µ–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
sed -i '/await callback.message.answer(f"<b>–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:/c\
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\n\
        file_path = f"analysis_{doc.id}.txt"\n\
        with open(file_path, "w", encoding="utf-8") as f:\n\
            f.write(result)\n\
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n\
        await callback.message.answer_document(\n\
            types.InputFile(path_or_bytesio=file_path, filename="analysis.txt"),\n\
            caption="üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤ —Ñ–∞–π–ª–µ"\n\
        )\n\
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª\n\
        os.remove(file_path)' "$FILE"

echo "‚úÖ main.py –æ–±–Ω–æ–≤–ª—ë–Ω: —Ç–µ–ø–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ —Ñ–∞–π–ª."
echo "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞: python main.py"

